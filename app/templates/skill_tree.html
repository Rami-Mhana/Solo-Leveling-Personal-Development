{% extends "base.html" %}
{% block title %}Skill Tree - Solo Leveling{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 py-6">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-4xl font-bold text-white bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 via-purple-400 to-pink-600 mb-2">
        Skill Tree
      </h1>
      <p class="text-gray-400">Obsidian-inspired knowledge graph. Hover nodes to explore. Click to view details.</p>
    </div>

    <!-- Network Graph Container -->
    <div class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-lg border border-purple-500/30 overflow-hidden shadow-2xl shadow-purple-500/20">
      <div id="network-graph" style="width: 100%; height: 650px; border: 1px solid rgba(168, 85, 247, 0.3); background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);"></div>
    </div>

    <!-- Legend -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
      <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-purple-500/50 transition-colors">
        <div class="flex items-center gap-3">
          <div class="w-4 h-4 rounded-full bg-green-500 shadow-lg shadow-green-500/50"></div>
          <span class="text-gray-300 text-sm">✓ Completed</span>
        </div>
      </div>
      <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-purple-500/50 transition-colors">
        <div class="flex items-center gap-3">
          <div class="w-4 h-4 rounded-full bg-yellow-400 shadow-lg shadow-yellow-400/50 animate-pulse"></div>
          <span class="text-gray-300 text-sm">● In Progress</span>
        </div>
      </div>
      <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-purple-500/50 transition-colors">
        <div class="flex items-center gap-3">
          <div class="w-4 h-4 rounded-full bg-gray-500"></div>
          <span class="text-gray-300 text-sm">◯ Unlocked</span>
        </div>
      </div>
      <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-purple-500/50 transition-colors">
        <div class="flex items-center gap-3">
          <div class="w-4 h-4 rounded-full bg-red-600 opacity-50"></div>
          <span class="text-gray-300 text-sm">✕ Locked</span>
        </div>
      </div>
    </div>

    <!-- Quest Details Modal -->
    <div id="quest-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" onclick="closeQuestModal()">
      <div class="bg-gradient-to-b from-gray-800 to-gray-900 rounded-lg border border-purple-500/40 max-w-md w-full mx-4 p-6 shadow-2xl shadow-purple-500/30" onclick="event.stopPropagation()">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h2 id="quest-title" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-pink-600"></h2>
            <p id="quest-description" class="text-gray-400 text-sm mt-2"></p>
          </div>
          <button onclick="closeQuestModal()" class="text-gray-500 hover:text-gray-300 transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <div class="mb-6 space-y-3">
          <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg border border-gray-600">
            <span class="text-gray-400 text-sm">XP Reward</span>
            <span id="quest-xp" class="text-yellow-400 font-bold text-lg"></span>
          </div>

          <div id="quest-status-container">
            <span id="quest-status" class="inline-block px-4 py-2 text-sm font-semibold rounded-lg"></span>
          </div>
        </div>

        <button onclick="closeQuestModal()" class="w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white rounded-lg transition-all duration-200 font-medium">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Vis.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />

<script>
  // Fetch skill nodes and edges from API
  async function initializeSkillTree() {
    try {
      const response = await fetch('{{ url_for("main.get_skill_nodes") }}');
      const data = await response.json();

      // Prepare nodes for Vis.js with Obsidian aesthetics
      const nodesData = new vis.DataSet(data.nodes.map(node => {
        // Obsidian-style colors: dark nodes with neon accents
        let bgColor = '#1a1a2e';  // Dark blue-black
        let borderColor = '#3a3a4e';
        let glowColor = 'rgba(168, 85, 247, 0.3)';

        // Color based on status
        if (node.status === 'completed') {
          bgColor = '#0f4c2f';  // Dark green
          borderColor = '#22c55e';  // Neon green
          glowColor = 'rgba(34, 197, 94, 0.4)';
        } else if (node.status === 'in-progress') {
          bgColor = '#3e2c0f';  // Dark amber
          borderColor = '#fbbf24';  // Neon gold
          glowColor = 'rgba(251, 191, 36, 0.4)';
        } else if (node.status === 'unlocked') {
          bgColor = '#1f2937';  // Dark gray
          borderColor = '#9ca3af';  // Gray
          glowColor = 'rgba(156, 163, 175, 0.2)';
        } else if (node.status === 'locked') {
          bgColor = '#2d1f1f';  // Dark red
          borderColor = '#7f1d1d';  // Dark red border
          glowColor = 'rgba(127, 29, 29, 0.2)';
        }

        const nodeConfig = {
          id: node.id,
          label: node.label,
          title: `${node.label}\nStatus: ${node.status}${node.xp_reward ? `\nXP: ${node.xp_reward}` : ''}`,
          color: {
            background: bgColor,
            border: borderColor,
            highlight: {
              background: bgColor,
              border: '#fbbf24'  // Gold highlight
            },
            hover: {
              background: bgColor,
              border: '#fbbf24'  // Gold on hover
            }
          },
          font: { 
            color: '#f0f0f0', 
            size: node.group === 'topic' ? 14 : 11,
            bold: { color: '#fbbf24', size: node.group === 'topic' ? 16 : 12 },
            multi: false
          },
          physics: true,
          shape: node.group === 'topic' ? 'box' : 'dot',
          size: node.group === 'topic' ? 32 : 24,
          borderWidth: 2.5,
          borderWidthSelected: 4,
          scaling: {
            label: true,
            min: 12,
            max: 28
          },
          shadow: {
            enabled: true,
            color: bgColor,
            size: 15,
            x: 0,
            y: 0
          },
          data: node
        };
        return nodeConfig;
      }));

      // Prepare edges for Vis.js - Obsidian style
      const edgesData = new vis.DataSet(data.edges.map(edge => ({
        from: edge.from,
        to: edge.to,
        arrows: {
          to: { enabled: true, scaleFactor: 0.6, type: 'arrow' }
        },
        dashes: edge.dashes || false,
        color: { 
          color: edge.dashes ? 'rgba(107, 114, 128, 0.3)' : 'rgba(251, 191, 36, 0.5)',
          highlight: edge.dashes ? 'rgba(107, 114, 128, 0.7)' : 'rgba(251, 191, 36, 0.8)',
          hover: edge.dashes ? 'rgba(107, 114, 128, 0.6)' : 'rgba(251, 191, 36, 0.7)'
        },
        width: edge.dashes ? 1.2 : 2,
        smooth: { 
          type: 'continuous',
          roundness: 0.6
        },
        shadow: {
          enabled: true,
          color: edge.dashes ? 'rgba(107, 114, 128, 0.2)' : 'rgba(251, 191, 36, 0.2)',
          size: 6,
          x: 0,
          y: 0
        }
      })));

      // Create network
      const container = document.getElementById('network-graph');
      const options = {
        physics: {
          enabled: true,
          stabilization: {
            iterations: 250,
            fit: true,
            updateInterval: 25
          },
          barnesHut: {
            gravitationalConstant: -2500,
            centralGravity: 0.3,
            springLength: 280,
            springConstant: 0.07,
            damping: 0.7
          },
          maxVelocity: 60,
          minVelocity: 0.5,
          solver: 'barnesHut',
          timestep: 0.5,
          forceAtlas2Based: {
            gravitationalConstant: -26,
            centralGravity: 0.005,
            springLength: 200,
            springConstant: 0.08,
            damping: 0.4,
            avoidOverlap: 0.2
          }
        },
        interaction: {
          hover: true,
          navigationButtons: true,
          keyboard: true,
          zoomView: true,
          dragView: true,
          tooltipDelay: 200
        },
        nodes: {
          margin: 12,
          widthConstraint: {
            maximum: 180
          }
        },
        edges: {
          smooth: {
            enabled: true,
            forceDirection: 'none',
            type: 'continuous'
          }
        }
      };

      const network = new vis.Network(container, { nodes: nodesData, edges: edgesData }, options);

      // Handle node clicks
      network.on('click', function(params) {
        if (params.nodes.length > 0) {
          const nodeId = params.nodes[0];
          const node = nodesData.get(nodeId);
          if (node && node.data) {
            showQuestModal(node.data);
          }
        }
      });

      // Prevent physics when zooming/panning
      network.on('dragStart', function() {
        network.physics.enabled = false;
      });

      network.on('dragEnd', function() {
        network.physics.enabled = true;
      });

      // Add node glow effects on hover
      network.on('hoverNode', function(params) {
        const nodeId = params.node;
        const node = nodesData.get(nodeId);
        if (node) {
          const canvas = container.querySelector('canvas');
          if (canvas) {
            canvas.style.cursor = 'pointer';
          }
        }
      });

      network.on('blurNode', function(params) {
        const canvas = container.querySelector('canvas');
        if (canvas) {
          canvas.style.cursor = 'default';
        }
      });

    } catch (error) {
      console.error('Error initializing skill tree:', error);
      document.getElementById('network-graph').innerHTML = '<div class="flex items-center justify-center h-full text-red-400"><i class="fas fa-exclamation-circle mr-3"></i> Error loading skill tree</div>';
    }
  }

  // Show quest details modal
  function showQuestModal(nodeData) {
    const modal = document.getElementById('quest-modal');
    document.getElementById('quest-title').textContent = nodeData.label || nodeData.title || 'Quest';
    document.getElementById('quest-description').textContent = nodeData.description || 'Complete this quest to unlock new challenges and master the skill.';
    
    const xpEl = document.getElementById('quest-xp');
    if (nodeData.xp_reward) {
      xpEl.textContent = `+${nodeData.xp_reward} XP`;
    } else {
      xpEl.textContent = nodeData.group === 'topic' ? 'Tutorial' : 'Varies';
    }
    
    const statusEl = document.getElementById('quest-status');
    const statusClasses = {
      'completed': 'bg-green-500/30 text-green-300 border border-green-500/50',
      'in-progress': 'bg-yellow-500/30 text-yellow-200 border border-yellow-500/50 shadow-lg shadow-yellow-500/20',
      'unlocked': 'bg-gray-600/30 text-gray-300 border border-gray-500/30',
      'locked': 'bg-red-900/30 text-red-300 border border-red-500/30'
    };
    const statusIcon = {
      'completed': '✓',
      'in-progress': '◆',
      'unlocked': '◯',
      'locked': '✕'
    };
    
    const status = nodeData.status || 'unlocked';
    statusEl.className = `inline-block px-4 py-2 text-sm font-semibold rounded-lg ${statusClasses[status] || statusClasses['unlocked']}`;
    statusEl.textContent = `${statusIcon[status]} ${status.charAt(0).toUpperCase() + status.slice(1)}`;
    
    modal.classList.remove('hidden');
  }

  // Close quest modal
  function closeQuestModal() {
    const modal = document.getElementById('quest-modal');
    modal.classList.add('hidden');
  }

  // Close modal when pressing ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeQuestModal();
    }
  });

  // Initialize on load
  document.addEventListener('DOMContentLoaded', initializeSkillTree);
</script>

<style>
  #network-graph {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(20, 30, 48, 0.8) 50%, rgba(15, 23, 42, 0.95) 100%);
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 0 30px rgba(251, 191, 36, 0.1), inset 0 0 60px rgba(168, 85, 247, 0.05);
  }

  /* Professional graph styling */
  #network-graph canvas {
    display: block;
    width: 100%;
    height: 100%;
    filter: contrast(1.05);
  }

  /* Obsidian neon glow effect */
  #network-graph::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    background: radial-gradient(
      ellipse at center,
      rgba(251, 191, 36, 0.08) 0%,
      rgba(168, 85, 247, 0.05) 40%,
      transparent 80%
    );
    opacity: 0.7;
    border-radius: 8px;
    z-index: 1;
  }

  /* Animated neon edges */
  .vis-edge {
    transition: all 0.2s ease;
    filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.3));
  }

  .vis-edge:hover {
    filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.6));
  }

  /* Node styling */
  .vis-node {
    transition: all 0.25s ease;
    filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.8));
  }

  .vis-node:hover {
    filter: drop-shadow(0 0 16px rgba(251, 191, 36, 0.8)) drop-shadow(0 0 8px rgba(168, 85, 247, 0.4));
    transform: scale(1.05);
  }

  /* Quest modal styles */
  #quest-modal {
    animation: fadeInScale 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(-10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* Tooltip styling */
  .vis-tooltip {
    background: rgba(17, 24, 39, 0.95) !important;
    border: 1px solid rgba(251, 191, 36, 0.4) !important;
    color: rgba(240, 240, 240, 0.9) !important;
    border-radius: 6px !important;
    padding: 8px 12px !important;
    font-size: 12px !important;
    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2), 0 0 20px rgba(168, 85, 247, 0.1) !important;
  }
</style>
{% endblock %}
