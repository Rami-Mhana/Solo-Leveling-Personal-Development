<!doctype html>
<html lang="en">
   <head>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <!-- Tailwind CSS -->
      <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
      <!-- FontAwesome -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
      <!-- Google Fonts - Gaming Inspired -->
      <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
      <!-- Custom CSS -->
      <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
      <!-- Alpine.js for Interactions -->
      <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
      <title>
          {% block title %}
            {{ title if title else 'Solo Leveling PD' }}
          {% endblock %}
      </title>
      <style>
        /* Neon glow effects */
        .neon-purple {
            text-shadow: 0 0 10px rgba(153, 50, 204, 0.8),
                        0 0 20px rgba(153, 50, 204, 0.8),
                        0 0 30px rgba(153, 50, 204, 0.6);
        }
        .neon-text {
            text-shadow: 0 0 10px currentColor;
        }
        /* Animated background */
        .animate-gradient {
            background: linear-gradient(270deg, var(--sl-purple), var(--sl-highlight));
            background-size: 200% 200%;
            animation: gradient 6s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Sidebar animation */
        @keyframes slideIn {
          from { transform: translateX(-100%); }
          to { transform: translateX(0); }
        }
        .sidebar-slide-in {
          animation: slideIn 0.3s ease-out forwards;
        }
        /* Achievement notification animation */
        @keyframes slideDown {
          0% { transform: translateY(-100%); opacity: 0; }
          10% { transform: translateY(0); opacity: 1; }
          90% { transform: translateY(0); opacity: 1; }
          100% { transform: translateY(-100%); opacity: 0; }
        }
        .notification-slide {
          animation: slideDown 4s ease-in-out forwards;
        }
      </style>
   </head>
   <body x-data="{ 
     sidebarOpen: window.innerWidth >= 768,
     notificationQueue: [],
     showNotification(message, type = 'achievement') {
       this.notificationQueue.push({ message, type });
       setTimeout(() => {
         this.notificationQueue.shift();
       }, 4000);
     }
   }">
    <!-- Achievement Notifications -->
    <div class="fixed top-0 right-0 z-50 p-4 space-y-4 pointer-events-none">
      <template x-for="notification in notificationQueue" :key="notification.message">
        <div class="notification-slide bg-gray-900 border border-purple-500 rounded-lg p-4 shadow-lg shadow-purple-500/20 flex items-center gap-3 pointer-events-auto">
          <div class="flex-shrink-0 w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center">
            <i class="fas fa-trophy text-white"></i>
          </div>
          <div class="flex-grow">
            <h4 class="text-white font-bold" x-text="notification.type === 'achievement' ? 'Achievement Unlocked!' : 'Level Up!'"></h4>
            <p class="text-gray-300 text-sm" x-text="notification.message"></p>
          </div>
        </div>
      </template>
    </div>

    <!-- Gaming Sidebar -->
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <div x-show="sidebarOpen" 
           x-transition:enter="transition-transform duration-300"
           x-transition:enter-start="-translate-x-full"
           x-transition:enter-end="translate-x-0"
           x-transition:leave="transition-transform duration-300"
           x-transition:leave-start="translate-x-0"
           x-transition:leave-end="-translate-x-full"
           class="bg-gray-900 w-64 shrink-0 border-r border-purple-500/20">
        <!-- Logo -->
        <div class="p-4 border-b border-gray-800">
          <a href="{{ url_for('main.index') }}" class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center">
              <i class="fas fa-dragon text-white text-xl"></i>
            </div>
            <span class="text-white font-bold text-xl neon-purple">Solo Leveling</span>
          </a>
        </div>

        <!-- User Status - Only show when authenticated -->
        {% if current_user.is_authenticated %}
        <div class="p-4 border-b border-gray-800">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-white font-bold text-lg">
              {{ current_user.username[0] | upper }}
            </div>
            <div>
              <h3 class="text-white font-medium" data-user-name>{{ current_user.username }}</h3>
              <p class="text-gray-400 text-sm" data-user-level>Level {{ current_user.level or 1 }}</p>
            </div>
          </div>
          {# Compute xp progress safely and expose data attribute for JS (# of percent) #}
          {% set xp_mod = current_user.xp % 1000 if current_user.xp else 0 %}
          {% set xp_progress = (xp_mod / 1000 * 100) if xp_mod is not none else 0 %}
          <!-- XP Bar -->
          <div class="w-full bg-gray-800 rounded-full h-2 mb-2" aria-hidden="true">
            <div data-xp-bar class="bg-gradient-to-r from-purple-500 to-pink-500 h-full rounded-full" 
                 style="width: {{ xp_progress }}%"></div>
          </div>
          <p class="text-gray-400 text-xs text-center" data-xp-text>
            {{ xp_mod }}/1000 XP to Next Level
          </p>
        </div>
        {% endif %}

        <!-- Navigation Links -->
        <nav class="p-4 space-y-2">
          <a href="{{ url_for('main.index') }}" 
             class="flex items-center gap-3 text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg p-3 transition-colors group">
            <div class="w-8 h-8 rounded bg-gray-800 group-hover:bg-purple-500/20 flex items-center justify-center transition-colors">
              <i class="fas fa-home text-purple-400"></i>
            </div>
            <span>Home</span>
          </a>
          
          <a href="{{ url_for('main.dashboard') }}" 
             class="flex items-center gap-3 text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg p-3 transition-colors group">
            <div class="w-8 h-8 rounded bg-gray-800 group-hover:bg-purple-500/20 flex items-center justify-center transition-colors">
              <i class="fas fa-chart-line text-purple-400"></i>
            </div>
            <span>Dashboard</span>
          </a>
          
          <a href="{{ url_for('main.profile') }}" 
             class="flex items-center gap-3 text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg p-3 transition-colors group">
            <div class="w-8 h-8 rounded bg-gray-800 group-hover:bg-purple-500/20 flex items-center justify-center transition-colors">
              <i class="fas fa-user-shield text-purple-400"></i>
            </div>
            <span>Hunter Profile</span>
          </a>
          
          <a href="{{ url_for('main.player_status') }}" 
             class="flex items-center gap-3 text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg p-3 transition-colors group">
            <div class="w-8 h-8 rounded bg-gray-800 group-hover:bg-purple-500/20 flex items-center justify-center transition-colors">
              <i class="fas fa-chart-bar text-purple-400"></i>
            </div>
            <span>Stats</span>
          </a>
          
          <a href="{{ url_for('main.market') }}" 
             class="flex items-center gap-3 text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg p-3 transition-colors group">
            <div class="w-8 h-8 rounded bg-gray-800 group-hover:bg-purple-500/20 flex items-center justify-center transition-colors">
              <i class="fas fa-store text-purple-400"></i>
            </div>
            <span>Market</span>
          </a>

          <a href="{{ url_for('learn.index') }}" 
             class="flex items-center gap-3 text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg p-3 transition-colors group">
            <div class="w-8 h-8 rounded bg-gray-800 group-hover:bg-purple-500/20 flex items-center justify-center transition-colors">
              <i class="fas fa-book-open text-purple-400"></i>
            </div>
            <span>Learn & Explore</span>
          </a>
        </nav>

        <!-- Auth Links -->
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-800">
          {% if current_user.is_authenticated %}
            <a href="{{ url_for('main.logout') }}" 
               class="flex items-center gap-3 text-gray-300 hover:text-white rounded-lg p-3 bg-red-500/10 hover:bg-red-500/20 transition-colors">
              <i class="fas fa-sign-out-alt text-red-400"></i>
              <span>Logout</span>
            </a>
          {% else %}
            <div class="flex items-center gap-2 justify-between">
              <a href="{{ url_for('main.login') }}" 
                 class="flex-1 inline-flex items-center gap-2 text-gray-300 hover:text-white rounded-md px-3 py-2 hover:bg-gray-800 transition-colors justify-center">
                <i class="fas fa-sign-in-alt text-purple-400"></i>
                <span class="text-sm">Login</span>
              </a>
              <a href="{{ url_for('main.register') }}" 
                 class="flex-1 inline-flex items-center gap-2 justify-center text-white rounded-md px-3 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 transition-colors text-sm">
                <i class="fas fa-user-plus"></i>
                <span>Register</span>
              </a>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col h-screen overflow-y-auto bg-gray-900">
        <!-- Top Bar -->
        <header class="bg-gray-800 border-b border-gray-700 h-16 flex items-center px-4 lg:px-6">
          <!-- Mobile Menu Button -->
          <button @click="sidebarOpen = !sidebarOpen"
                  class="w-10 h-10 rounded-lg hover:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
            <i class="fas" :class="sidebarOpen ? 'fa-times' : 'fa-bars'"></i>
          </button>
          
          <!-- Right Side Actions -->
          <div class="ml-auto flex items-center gap-4">
            {% if current_user.is_authenticated %}
              <!-- Notifications -->
              <button class="w-10 h-10 rounded-lg hover:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-white transition-colors relative">
                <i class="fas fa-bell"></i>
                <span class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-purple-500 text-white text-xs flex items-center justify-center">3</span>
              </button>
              
              <!-- Quest Log -->
              <button class="w-10 h-10 rounded-lg hover:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-scroll"></i>
              </button>
              
              <!-- Settings -->
              <button class="w-10 h-10 rounded-lg hover:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-cog"></i>
              </button>
            {% endif %}
          </div>
        </header>
      <!-- Content -->
      <main class="flex-1 p-4 lg:p-6">
        {% block content %}
        {% endblock %}
      </main>
    </div>
  </div>

  <!-- Achievement Sound Effects -->
  <audio id="achievement-sound" preload="auto">
    <source src="{{ url_for('static', filename='sounds/achievement.mp3') }}" type="audio/mpeg">
  </audio>
  <audio id="levelup-sound" preload="auto">
    <source src="{{ url_for('static', filename='sounds/levelup.mp3') }}" type="audio/mpeg">
  </audio>

  <!-- Optional JavaScript -->
  <script>
    // Notification System
    const notificationSystem = {
      init() {
        this.notificationQueue = [];
        this.isProcessing = false;
      },

      async showNotification(data) {
        const notification = document.querySelector('[x-data]').__x.$data;
        
        // Play sound effect
        const sound = document.getElementById(
          data.type === 'levelup' ? 'levelup-sound' : 'achievement-sound'
        );
        if (sound) {
          sound.currentTime = 0;
          await sound.play().catch(() => {/* Ignore autoplay errors */});
        }
        
        // Show notification
        notification.showNotification(data.message, data.type);
        
        // Update stats if provided
        if (data.progress) {
          this.updateStats(data.progress);
        }
      },

      updateStats(progress) {
        // Update level and rank (be tolerant of templates that include the word "Level")
        if (progress.level !== undefined && progress.level !== null) {
          document.querySelectorAll('[data-user-level]')
            .forEach(el => {
              const text = (el.textContent || '').trim();
              if (text.toLowerCase().startsWith('level')) {
                el.textContent = `Level ${progress.level}`;
              } else {
                el.textContent = `${progress.level}`;
              }
            });
        }
        if (progress.rank) {
          document.querySelectorAll('[data-user-rank]')
            .forEach(el => el.textContent = progress.rank);
        }

        // Update XP bar (clamp and format)
        const xpBar = document.querySelector('[data-xp-bar]');
        const xpPct = Number(progress.xp_progress || 0);
        if (xpBar) {
          const pct = Math.max(0, Math.min(100, isNaN(xpPct) ? 0 : xpPct));
          xpBar.style.width = `${pct}%`;
        }

        // Update stats (guard stat-value existence)
        Object.entries(progress.stats || {}).forEach(([stat, value]) => {
          const statBar = document.querySelector(`[data-stat="${stat}"]`);
          if (statBar) {
            const pct = Math.max(0, Math.min(100, Number(value) || 0));
            statBar.style.width = `${pct}%`;
            const statValueEl = statBar.parentElement && statBar.parentElement.querySelector('.stat-value');
            if (statValueEl) {
              statValueEl.textContent = `${value}`;
            }
          }
        });
      }
    };

    // Initialize notification system
    notificationSystem.init();

    // Activity Completion Handler
    async function completeActivity(type, id = null) {
      try {
        const response = await fetch(`/complete-${type}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({ type, id: id || '' })
        });

        const data = await response.json();
        
        if (data.success) {
          // Show notifications
          for (const notification of data.notifications) {
            await notificationSystem.showNotification(notification);
          }
          
          // Update progress
          if (data.progress) {
            notificationSystem.updateStats(data.progress);
          }

          // Trigger success animation on the completed item
          if (id) {
            const element = document.querySelector(`[data-activity="${id}"]`);
            if (element) {
              element.classList.add('activity-completed');
              setTimeout(() => {
                element.classList.add('fade-out');
              }, 1000);
            }
          }
        }
      } catch (error) {
        console.error('Error completing activity:', error);
      }
    }

    // Achievement animations
    document.addEventListener('achievement-earned', async (event) => {
      const { achievement } = event.detail;
      await notificationSystem.showNotification({
        type: 'achievement',
        message: `Achievement Unlocked: ${achievement.title}!`
      });
    });

    // Level up animations
    document.addEventListener('level-up', async (event) => {
      const { level, rank } = event.detail;
      await notificationSystem.showNotification({
        type: 'levelup',
        message: `Advanced to Level ${level}${rank ? ` - ${rank}` : ''}!`
      });
    });

    // Quest completion animation
    function createQuestCompletionEffect(element) {
      // Create particles
      const particles = Array.from({ length: 20 }, () => {
        const particle = document.createElement('div');
        particle.className = 'absolute w-2 h-2 bg-yellow-400 rounded-full';
        return particle;
      });
      
      // Add particles to the element
      particles.forEach(particle => {
        element.appendChild(particle);
        
        // Random position and animation
        const angle = Math.random() * Math.PI * 2;
        const velocity = 2 + Math.random() * 2;
        const distance = 50 + Math.random() * 50;
        
        particle.animate([
          {
            transform: 'translate(0, 0) scale(1)',
            opacity: 1
          },
          {
            transform: `translate(
              ${Math.cos(angle) * distance}px,
              ${Math.sin(angle) * distance}px
            ) scale(0)`,
            opacity: 0
          }
        ], {
          duration: 1000,
          easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
          fill: 'forwards'
        });
      });
      
      // Clean up particles
      setTimeout(() => {
        particles.forEach(particle => particle.remove());
      }, 1000);
    }
  </script>

  <style>
    /* Activity completion animation */
    @keyframes complete-activity {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(0); opacity: 0; }
    }
    
    .activity-completed {
      animation: complete-activity 1s ease-out forwards;
    }
    
    .fade-out {
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s ease-out;
    }
  </style>
</body>
</html>